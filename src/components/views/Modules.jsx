import { useAuth } from "../auth/authContext.jsx";
import useLoad from "../api/useLoad.js";
import apiURL from "../api/apiURL.js";
import API from "../api/API.js";
import { Modal, useModal } from "../UI/Modal.jsx";
import { Alert, Error, useAlert } from "../UI/Alert.jsx";
import Spacer from "../UI/Spacer.jsx";
import Action from "../UI/Actions.jsx";
import ModuleForm from "../entity/module/ModuleForm.jsx";
import { CardContainer } from "../UI/Card.jsx";
import ModuleCard from "../entity/module/ModuleCard.jsx";

const Modules = () => {
  // Initialisation
  const { loggedInUser } = useAuth();
  const modulesEndpoint =
    loggedInUser.UserUsertypeID === 1
      ? `${apiURL}/modules/leader/${loggedInUser.UserID}`
      : `${apiURL}/modules/users/${loggedInUser.UserID}`;
  const postModuleEndpoint = `${apiURL}/modules`;

  // State
  const [modules, loadingMessage, loadModules] = useLoad(modulesEndpoint);
  const [isFormOpen, openForm, closeForm] = useModal(false);
  const [isAlertOpen, alertMessage, openAlert, closeAlert] = useAlert();
  const [isErrorOpen, errorMessage, openError, closeError] = useAlert();

  // Handlers
  const handleSubmit = async (module) => {
    const result = await API.post(postModuleEndpoint, module);
    if (result.isSuccess) {
      closeForm();
      loadModules(modulesEndpoint);
      openAlert("Submission Successful");
    } else openError(`Submission Unsuccessful: ${result.message}`);
  };

  // View
  return (
    <>
      <h1>Modules</h1>

      {isFormOpen && (
        <Modal title="Add New Module">
          <ModuleForm onSubmit={handleSubmit} onCancel={closeForm} />
        </Modal>
      )}

      {isAlertOpen && <Alert message={alertMessage} onDismiss={closeAlert} />}
      {isErrorOpen && <Error message={errorMessage} onDismiss={closeError} />}

      <Spacer>
        <Action.Tray>
          <Action.Add showText buttonText="Add New Module" onClick={openForm} />
        </Action.Tray>

        {!modules ? (
          <p>{loadingMessage}</p>
        ) : (
          <CardContainer>
            {modules.map((module) => (
              <ModuleCard key={module.ModuleID} module={module} />
            ))}
          </CardContainer>
        )}
      </Spacer>
    </>
  );
};

export default Modules;
